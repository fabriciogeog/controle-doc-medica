<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Cadastro</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .status {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        #logOutput {
            max-height: 400px;
            overflow-y: auto;
            background: #212529;
            color: #f8f9fa;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            border-radius: 4px;
        }
        .form-test {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Elementos DOM necess√°rios -->
    <div id="loginModal" class="modal" style="display: none;"></div>
    <div id="app" style="display: block;">
        <header class="app-header">
            <div class="header-content">
                <h1>üß™ Teste de Cadastro de Documentos</h1>
            </div>
        </header>

        <main class="main-content">
            <!-- Status -->
            <div class="debug-section">
                <h3>üìä Status da Autentica√ß√£o</h3>
                <div id="statusAuth">
                    <button onclick="fazerLogin()" class="btn btn-primary">üîë Fazer Login Teste</button>
                    <button onclick="verificarAuth()" class="btn btn-outline">‚úÖ Verificar Auth</button>
                </div>
            </div>

            <!-- Teste de Cadastro -->
            <div class="form-test">
                <h3>üìù Formul√°rio de Teste de Cadastro</h3>
                <form id="cadastroForm" onsubmit="testarCadastro(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipoDocumento" class="required">Tipo do Documento:</label>
                            <select id="tipoDocumento" name="tipoDocumento" required>
                                <option value="">Selecione...</option>
                                <option value="Exame">Exame</option>
                                <option value="Laudo">Laudo</option>
                                <option value="Receita">Receita</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="especialidadeMedica" class="required">Especialidade M√©dica:</label>
                            <input type="text" id="especialidadeMedica" name="especialidadeMedica" required value="Cardiologia">
                        </div>
                        
                        <div class="form-group">
                            <label for="dataSolicitacaoEmissao" class="required">Data do Documento:</label>
                            <input type="date" id="dataSolicitacaoEmissao" name="dataSolicitacaoEmissao" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="profissionalNome" class="required">Nome do Profissional:</label>
                            <input type="text" id="profissionalNome" name="profissionalSolicitante.nome" required value="Dr. Jo√£o Silva">
                        </div>
                        
                        <div class="form-group">
                            <label for="profissionalRegistro" class="required">Registro Profissional:</label>
                            <input type="text" id="profissionalRegistro" name="profissionalSolicitante.numeroRegistro" required value="CRM/SP 123456">
                        </div>
                        
                        <div class="form-group">
                            <label for="profissionalEspecialidade">Especialidade do Profissional:</label>
                            <input type="text" id="profissionalEspecialidade" name="profissionalSolicitante.especialidade" value="Cardiologista">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="descricao" class="required">Descri√ß√£o:</label>
                            <textarea id="descricao" name="descricao" rows="4" required>Teste de cadastro automatizado via interface web</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="instituicaoNome" class="required">Nome da Institui√ß√£o:</label>
                            <input type="text" id="instituicaoNome" name="instituicao.nome" required value="Hospital Teste">
                        </div>
                        
                        <div class="form-group">
                            <label for="instituicaoCnpj">CNPJ da Institui√ß√£o:</label>
                            <input type="text" id="instituicaoCnpj" name="instituicao.cnpj" value="12.345.678/0001-90">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="tags">Tags (separadas por v√≠rgula):</label>
                            <input type="text" id="tags" name="tags" value="teste, cadastro, automatico">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="caminhos">Caminhos dos Arquivos:</label>
                            <textarea id="caminhos" name="caminhos" rows="3">/home/fabricio/Documentos/Assuntos - Pedro/Pedro - Sa√∫de/teste_cardiologia.pdf
/home/fabricio/Documentos/Assuntos - Pedro/Pedro - Sa√∫de/resultado_exame.jpg</textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="observacoes">Observa√ß√µes:</label>
                            <textarea id="observacoes" name="observacoes" rows="3">Teste automatizado de cadastro de documento m√©dico</textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Testar Cadastro</button>
                        <button type="button" onclick="limparFormulario()" class="btn btn-outline">üóëÔ∏è Limpar</button>
                        <button type="button" onclick="preencherDataHoje()" class="btn btn-outline">üìÖ Data Hoje</button>
                    </div>
                </form>
            </div>

            <!-- Log -->
            <div class="debug-section">
                <h3>üìã Log de Testes</h3>
                <div id="logOutput">Aguardando teste de cadastro...</div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="modal"></div>
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Processando...</p>
    </div>
    <div id="toast" class="toast" style="display: none;">
        <div id="toastMessage"></div>
    </div>

    <!-- Links -->
    <div style="text-align: center; padding: 20px; background: #f8f9fa; margin-top: 20px;">
        <a href="/" class="btn btn-primary">üè† Sistema Principal</a>
        <a href="/teste-completo.html" class="btn btn-outline">üß™ Teste Completo</a>
    </div>

    <script src="js/app.js"></script>
    <script>
        function log(message) {
            const output = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        // Fazer login autom√°tico para teste
        async function fazerLogin() {
            log('üîë Fazendo login de teste...');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ senha: 'DocMed2025' })
                });

                const data = await response.json();
                if (data.success) {
                    log('‚úÖ Login realizado com sucesso!');
                    document.getElementById('statusAuth').innerHTML = '<div class="status success">‚úÖ Autenticado com sucesso</div>';
                } else {
                    log(`‚ùå Erro no login: ${data.message}`);
                    document.getElementById('statusAuth').innerHTML = `<div class="status error">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o no login: ${error.message}`);
            }
        }

        async function verificarAuth() {
            log('‚úÖ Verificando autentica√ß√£o...');
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                
                if (data.authenticated) {
                    log('‚úÖ Usu√°rio autenticado');
                    document.getElementById('statusAuth').innerHTML = '<div class="status success">‚úÖ Usu√°rio autenticado</div>';
                } else {
                    log('‚ùå Usu√°rio n√£o autenticado');
                    document.getElementById('statusAuth').innerHTML = '<div class="status error">‚ùå N√£o autenticado - fa√ßa login primeiro</div>';
                }
            } catch (error) {
                log(`‚ùå Erro ao verificar autentica√ß√£o: ${error.message}`);
            }
        }

        async function testarCadastro(event) {
            event.preventDefault();
            
            log('üìù Iniciando teste de cadastro...');
            
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            try {
                const form = event.target;
                const formData = new FormData(form);
                
                // Log dos dados que ser√£o enviados
                log('üìä Dados do formul√°rio:');
                for (let [key, value] of formData.entries()) {
                    log(`   ${key}: ${value}`);
                }

                const response = await fetch('/api/documentos', {
                    method: 'POST',
                    body: formData
                });

                const responseText = await response.text();
                log(`üì• Resposta do servidor (status ${response.status}): ${responseText}`);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    log(`‚ùå Erro ao interpretar resposta JSON: ${parseError.message}`);
                    data = { success: false, message: 'Resposta inv√°lida do servidor' };
                }

                if (data.success) {
                    log('‚úÖ Documento cadastrado com sucesso!');
                    log(`üÜî ID do documento: ${data.data?._id || 'N/A'}`);
                    if (window.app && typeof window.app.showToast === 'function') {
                        window.app.showToast('Documento cadastrado com sucesso!', 'success');
                    }
                } else {
                    log(`‚ùå Erro no cadastro: ${data.message}`);
                    if (data.errors) {
                        data.errors.forEach(error => {
                            log(`   Erro: ${error.msg} (campo: ${error.param})`);
                        });
                    }
                    if (window.app && typeof window.app.showToast === 'function') {
                        window.app.showToast(data.message || 'Erro no cadastro', 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`);
                if (window.app && typeof window.app.showToast === 'function') {
                    window.app.showToast('Erro de conex√£o', 'error');
                }
            } finally {
                loading.style.display = 'none';
            }
        }

        function limparFormulario() {
            document.getElementById('cadastroForm').reset();
            log('üóëÔ∏è Formul√°rio limpo');
        }

        function preencherDataHoje() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataSolicitacaoEmissao').value = hoje;
            log(`üìÖ Data preenchida com hoje: ${hoje}`);
        }

        // Auto-login quando carregar
        document.addEventListener('DOMContentLoaded', () => {
            fazerLogin();
            preencherDataHoje();
        });
    </script>
</body>
</html>
